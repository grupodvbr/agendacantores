<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Agenda de M√∫sicos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
  <style>
    body{margin:0;font-family:sans-serif;background:#0b0b15;color:#fff;}
    header{padding:12px 18px;background:rgba(0,0,0,.6);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:20}
    h1{margin:0;font-size:20px;color:#ffd700;}
    h2{margin:0;font-size:14px;font-weight:400;font-style:italic}
    #calendarBtn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700;background:#ffd700;color:#000}
    .content{padding:18px;max-width:800px;margin:0 auto}
    .lista{display:flex;flex-direction:column;gap:14px}
    .grupo{display:grid;grid-template-columns:70px 1fr;gap:14px}
    .dia{display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:22px}
    .dia small{color:#ffd700;font-size:12px}
    .itens{border-left:4px solid #ffd700;padding-left:12px;display:flex;flex-direction:column;gap:10px}
    .linha{background:rgba(255,255,255,.06);padding:10px;border-radius:10px;display:flex;justify-content:space-between}
    .hora{color:#aaa}
    .passado{background:rgba(0,255,128,.15)!important}
    /* Loader */
    #loader{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:100}
    .spinner{width:60px;height:60px;border:6px solid rgba(255,255,255,.2);border-top:6px solid #ffd700;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    /* Bot√£o + */
    #addBtn{position:fixed;bottom:20px;right:20px;background:#ffd700;color:#000;border:none;border-radius:50%;font-size:28px;font-weight:900;width:54px;height:54px;cursor:pointer;z-index:200}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Agenda</h1>
      <h2 id="empresaNome">Mercatto Del√≠cia</h2>
    </div>
    <input id="calendarBtn" readonly />
  </header>

  <div class="content"><main class="lista" id="lista"></main></div>

  <div id="loader"><div class="spinner"></div></div>
  <button id="addBtn">+</button>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbzk3tiR8XssMBrmabs20JV0Lr9C7WTdzaoSXBgkvS-se9doBdk156XSkfVa5Fn0iQoZ/exec";
let filtroDe=null,filtroAte=null;

const pad=n=>n.toString().padStart(2,"0");
const toDateKey=d=>{if(!d)return null;const dt=new Date(d);return isNaN(dt)?null:`${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}`};
const formatHora=h=>h?String(h).slice(0,5):"--:--";

function mostrarLoader(v){document.getElementById("loader").style.display=v?"flex":"none";}

async function carregarAgenda(){
  mostrarLoader(true);
  const box=document.getElementById("lista");
  box.innerHTML="";
  try{
    let eventos=await (await fetch(API_URL)).json();

    // seguran√ßa: se resposta n√£o for array
    if(!Array.isArray(eventos)){box.innerHTML="<p>‚ö†Ô∏è Nenhum dado retornado.</p>";mostrarLoader(false);return;}

    // aplica filtro
    if(filtroDe&&filtroAte){
      const from=toDateKey(filtroDe),to=toDateKey(filtroAte);
      eventos=eventos.filter(ev=>{
        const k=toDateKey(ev.data);
        return k&&k>=from&&k<=to;
      });
    }

    // agrupa por data
    const grupos={};
    eventos.forEach(ev=>{
      const k=toDateKey(ev.data);
      if(!k) return;
      (grupos[k] ||= []).push(ev);
    });

    const dias=Object.keys(grupos).sort();
    if(!dias.length){box.innerHTML="<p>üì≠ Sem eventos no per√≠odo.</p>";mostrarLoader(false);return;}

    const hojeKey=toDateKey(new Date());
    dias.forEach(k=>{
      const [y,m,d]=k.split("-");
      const dia=d,mes=new Date(y,m-1,d).toLocaleString("pt-BR",{month:"short"}).toUpperCase();
      const passado=k<hojeKey?" passado":"";
      const itens=grupos[k].map(ev=>
        `<div class="linha${passado}"><div>${ev.cantor||"‚Äî"}</div><div class="hora">${formatHora(ev.hora)}</div></div>`
      ).join("");
      box.innerHTML+=`<section class="grupo"><div class="dia">${dia}<small>${mes}</small></div><div class="itens">${itens}</div></section>`;
    });

  }catch(e){
    console.error(e);
    document.getElementById("lista").innerHTML="<p>‚ùå Erro ao carregar.</p>";
  }
  mostrarLoader(false);
}

// Flatpickr
let calendar=flatpickr("#calendarBtn",{mode:"range",dateFormat:"d/m/Y",locale:"pt",
  onClose:(dates)=>{filtroDe=dates[0]||null;filtroAte=dates[1]||null;carregarAgenda();}
});

// define semana vigente por padr√£o
(function(){
  const hoje=new Date();const dia=hoje.getDay();
  const segunda=new Date(hoje);segunda.setDate(hoje.getDate()-((dia+6)%7));
  const domingo=new Date(segunda);domingo.setDate(segunda.getDate()+6);
  filtroDe=segunda;filtroAte=domingo;
  calendar.setDate([segunda,domingo],true);
})();

carregarAgenda();
</script>
</body>
</html>
